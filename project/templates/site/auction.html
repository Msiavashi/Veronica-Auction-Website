{% extends 'site/layout.html' %}
{% block title %} بردیتو | حراجی محصول {% endblock %}
{% block content %}
<input type="hidden" id="auction" value="{{auction_id}}">
<div id="app" class="content-page">
	<div class="container">
		<div class="bread-crumb radius">
		{%raw%}
			<a href="/">خانه</a> <span>{{auctionTitle}}</span>
		{%endraw%}
		</div>
		<!-- End Bread Crumb -->
		<div class="row">
			<div class="col-md-12">
				<div class="product-detail detail-with-sidebar config-detail border radius">

					<div>
						<div class="row">
							<div class="col-md-4 col-sm-12 col-xs-12">
								<div class="product-extra-link2 rightList">
									{%raw%}
									<a class="wishlist-link" href="#"><i aria-hidden="true" class="fa fa-times">{{_ToPersian(auctionRatio)}}ضریب</i></a>
			            <a class="wishlist-link" href="#"><i aria-hidden="true" class="fa fa-users"></i><span>{{_ToPersian(auctionParticipants.length)}}</span> از <span>{{_ToPersian(auctionMaxMembers)}}</span></a>
									{%endraw%}
			          </div>
								<div class="detail-gallery">
									<div class="mid">
										<img v-bind:src="activeImage" alt=""/>
									</div>
									<div class="gallery-control">
										<a href="#" class="prev"><i class="fa fa-angle-left"></i></a>
										<div class="carousel">
											<ul v-for="image in images">
												<li><a href="#"><img v-bind:src="image" alt=""/></a></li>
											</ul>
										</div>
										<a href="#" class="next"><i class="fa fa-angle-right"></i></a>
									</div>
								</div>
								<!-- End Gallery -->
								<div class="detail-without-sidebar">
									<div class="detail-social">
										<ul class="list-social-detail list-inline-block">
											<li><a href="#" class="soci-fa soc-tumblr"><i class="fa fa-tumblr" aria-hidden="true"></i></a></li>
											<li><a href="#" class="soci-fa soc-facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
											<li><a href="#" class="soci-fa soc-twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
											<li><a href="#" class="soci-fa soc-print"><i class="fa fa-print" aria-hidden="true"></i></a></li>
											<li>
												<div class="more-social">
													<a class="soci-fa add-link soc-add" href="#"><i aria-hidden="true" class="fa fa-plus"></i><span>7</span></a>
													<ul class="list-social-share list-none">
														<li><a href="#"><i class="fa fa-youtube" aria-hidden="true"></i><span>Youtute</span></a></li>
														<li><a href="#"><i class="fa fa-linkedin"></i><span>linkedin</span></a></li>
														<li><a href="#"><i class="fa fa-pinterest"></i><span>pinterest</span></a></li>
														<li><a href="#"><i class="fa fa-google"></i><span>google</span></a></li>
														<li><a href="#"><i class="fa fa-instagram"></i><span>instagram</span></a></li>
														<li><a href="#"><i class="fa fa-flickr"></i><span>flickr</span></a></li>
														<li><a href="#"><i class="fa fa-reddit"></i><span>reddit</span></a></li>
													</ul>
												</div>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<div class="col-md-8 col-sm-12 col-xs-12">
								<div class="detail-info">
											{%raw%}
									<h2 class="title-detail">{{auctionTitle}}</h2>
											{%endraw%}
									<div class="product-price">
										<!-- <a href="#" class="shopnow"><span>شرکت در حراجی</span></a> -->
										<div class="textboX">
											{%raw%}
											<div class="textboXX"><p> قیمت محصول : <span>{{_ToPersian(_formatCurrency(auction.item.price))}}</span> تومان <div> &nbsp  </div></p></div>
											{%endraw%}
											<div class="upArrow"></div>
										</div>
										<div class="textboX">
											<div class="textboXX">
											{%raw%}
												<p id="auction_register_price">شروع حراجی : <span>{{_ToPersian(_formatCurrency(auctionBasePrice))}}</span> تومان
												<div>  سقف حراجی : <span>{{_ToPersian(_formatCurrency(auctionMaxPrice))}}</span> تومان </p></div>
											{%endraw%}
											</div>
											<div class="upArrow"></div>
										</div>
									</div>
									<div class="detail-extralink">
										<div class="list-member-bid" v-for="(person, index) in people">
											<p class="item-Bid" v-bind:style="{'YOU':person.its_me}">
												<img v-bind:src="person.avatar"/>
												<br class="resWd"/>
											{%raw%}
												<label>{{person.name}}</label>
												<span>{{index}}</span>
												<b>{{person.price}}</b>
											{%endraw%}
											</p>
										</div>

										<div class="product-extra-link2 resWi">
											<div class="last-Bid-user">
											{%raw%}
												<p class="img-price-Bid"><img id="auction_current_winner_image"/></p>
												<p class="price-Bid"><span id="auction_current_offer">{{auctionCurrentOffer}}</span>{{currentOfferPrice}} تومان</p>
												<p class="name-price-Bid" id="auction_current_winner">{{auctionCurrentWinner}}</p>
											{%endraw%}
											</div>
											<input type="hidden" id="set-time" value="1"/>
											{%raw%}
											<div id="countdown">
												<div id='tiles' class="color-full">{{remainingTime}}</div>
												<div class="countdown-label">{{now_date}}</div>
											</div>
											<a class="addcart-link" href="#" @click.prevent="handleBid" id="offer">پیشنهاد <div class="detail-qty border radius" id="offer_count">{{_ToPersian(offer_bid_count)}}</div></a>
											{%endraw%}
										</div>

										<div class="alert alert-danger error_alert hide">
											<a href="#" class="close" aria-label="close">×</a>
											<div class="error_container"></div>
										</div>

										<div class="alert alert-success alert-dismissable success_alert hide">
											<a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
											<div class="success_container"></div>
										</div>

										<div class="detail-countdowns">شروع حراجی : </span>

											{%raw%}
			                <span>{{auction_end_date}}</span>
			                <i aria-hidden="true" class="fa fa-clock-o"></i><span>{{auction_end_time}}</span>
											{%endraw%}
			              </div>
									</div>
									<div class="detail-extralink mt-0">
										<div class="product-extra-link2">
											<a class="addcart-link2" href="#"><i class="fa fa-shopping-basket" aria-hidden="true" id="add_to_bag"><input type="hidden" v-bind:value ="auction.item.id"></i> اضافه به سبد</a>
											<a class="wishlist-link2" href="#"><i aria-hidden="true" class="fa fa-heart"></i></a>
											<a class="wishlist-link2 text-red" href="#"><i aria-hidden="true" class="fa fa-percent"></i><span id="discount"></span> تومان</a>
										</div>
									</div>
								</div>
								<!-- Detail Info -->
							</div>
						</div>
					</div>

					<div class="tab-detal hoz-tab-detail">
						<div class="hoz-tab-title">
							<ul>
								<li class="active"><a href="#hoz1" data-toggle="tab">اطلاعات</a></li>
								<li><a href="#hoz2" data-toggle="tab">مشخصات فنی</a></li>
								<li><a href="#hoz3" data-toggle="tab">مشخصات</a></li>
								<!-- <li><a href="#hoz4" data-toggle="tab">مشخصات</a></li>
								<li><a href="#hoz5" data-toggle="tab">مشخصات</a></li>
								<li><a href="#hoz6" data-toggle="tab">مشخصات</a></li> -->
							</ul>
						</div>
						<div class="tab-content">
							<div id="hoz1" class="tab-pane active">
								<div class="hoz-tab-content">
									<div class="content-detail-tab">
										<div class="detail-tab-info">
											{%raw%}
											<p class="desc">{{auction.desciption}}</p>
												<ul>
													<li>{{auction.item.product.desciption}}</li>
											</ul>
											{%endraw%}
										</div>
									</div>
								</div>
							</div>
							<div id="hoz2" class="tab-pane">
								<div class="hoz-tab-content">
									<div class="content-detail-tab">
										<div class="detail-tab-info">
											{%raw%}
											<p class="desc">{{auction.desciption}}</p>
												<ul>
													<li>{{auction.item.product.desciption}}</li>
											</ul>
											{%endraw%}
										</div>
									</div>
								</div>
							</div>
							<div id="hoz3" class="tab-pane">
								<div class="hoz-tab-content">
									<div class="content-detail-tab">
										<div class="detail-tab-info">
											{%raw%}
											<p class="desc" >{{auction.desciption}} </p>
												<ul>
													<li> {{auction.item.product.desciption}} </li>
											</ul>

											{%endraw%}
										</div>
									</div>
								</div>
							</div>

						</div>
					</div>

				</div>
				<!-- End Main Detail -->
				<div class="sidebar">
					<div class="list-detail-adv">
						<div class="detail-adv">
							<a href="#"><img class="radius wobble-horizontal" alt="" src="/static/images/theme/pro-adv1.jpg"></a>
						</div>
						<div class="detail-adv">
							<a href="#"><img class="radius wobble-horizontal" alt="" src="/static/images/theme/pro-adv2.jpg"></a>
						</div>
						<div class="detail-adv">
							<a href="#"><img class="radius wobble-horizontal" alt="" src="/static/images/theme/pro-adv3.jpg"></a>
						</div>
					</div>
				</div>
				<!-- End Product Related -->
			</div>
		</div>

	</div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/owl.carousel.js')}} "></script>
<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/jquery.jcarousellite.js')}} "></script>
<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/jquery.elevatezoom.js')}} "></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/js_config.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/libs/knockout.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/libs/persian-date.min.js')}}"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue-socket.io@2.1.1-b/dist/build.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vuex/3.0.1/vuex.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script>

var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

var app = new Vue({

	el: "#app",

	data:{
		auctionCurrentWinnerImage: "#",
		winnerUser: null,
		auctionCurrentOffer: 0,
		offer_bid_count: 0,
		currentOfferPrice: 0,
		interval: null,
		timerSync: null,
		remainingTime: null,
		activeImage: null,
		images: [],
		people: [],
		auctionBasePrice: null,
		auctionDescription: "",
		auctionMaxMembers: null,
		auctionRatio: null,
		auctionMaxPrice: null,
		auctionTitle: "",
		auctionParticipants: [],
		auction: {},
		users: [],
		active_user: null
	},

	methods: {

		handleBid: function(){
			socket.emit("bid", {
				auction_id: "{{auction_id}}",
			});
		},

		_ToPersian: function(data){
			return ToPersian(data);
		},

		_formatCurrency: function(number){
			return formatCurrency(number);
		},

		getRemainTime: function(){
			socket.emit("get_remain_time", {auction_id: "{{auction_id}}"});
		},

		setAuctionInformation: function(auction){
			this.images = [];
			ClearifyNames(auction.item.images).forEach(image => {
				this.images.push(images_path + image);
			});
			this.auction = auction;
			this.activeImage = this.images[0];
			this.auctionBasePrice = auction.base_price;
			this.auctionDescription = auction.description;
			this.auctionMaxPrice = auction.max_price
			this.auctionRatio = auction.ratio;
			this.auctionTitle = auction.title;
			this.auctionMaxMembers = auction.max_members;
			this.auctionParticipants = auction.participants;
			
		},

		setPlanInformation: function(plan){
			console.log(plan);
			if (plan){
				this.offer_bid_count = plan.max_offers;
			}
		},

		setProductInformation: function(product){

		}
	},
	beforeCreate: function(){
		var self = this;
		socket.emit("join", {auction_id: '{{auction_id}}'});
		socket.emit("get_remain_time", {auction_id: "{{auction_id}}"});
		


		axios.get("{{url_for('auctioninstanceview', aid=auction_id)}}")
			.then((response) => {
				console.log(response.data);
				this.setProductInformation(response.data.product[0]);
				this.setPlanInformation(response.data.plan[0]);
				this.setAuctionInformation(response.data.auction[0]);
			})
			.catch((response)=>{
				console.error(response.data);
			});
			

	},

	created: function(){

	},


	computed: {
		auction_end_date: function(){
			// return full_date = new persianDate(new Date(this.remainingTime)).format("dddd DD MMMM YYYY");
		},

		auction_end_time: function(){
			// return full_date = new persianDate(new Date(this.remainingTime)).format("dddd DD MMMM YYYY");
		},

		now_date: function(){
			return new persianDate(new Date()).format("dddd DD MMMM YYYY");
		}
	},

	// countdown
	mounted: function(){
			this.interval = setInterval(()=>{
				var seconds = moment.duration(this.remainingTime).asSeconds() - 1;
				this.remainingTime = moment.utc(seconds*1000).format('HH:mm:ss');
			}, 1000);
			
			// sync timer with server every 3 seconds
			this.timerSync = setInterval(() => {
				socket.emit('get_remain_time', {auction_id: "{{auction_id}}"});
			}, 3000);
	},

});

 socket.on('connect', function() {
		 console.log('connected');
 });

// setInterval(()=>{
// 	console.log('syncing...:' + "{{current_user.id}}");
// 	socket.emit('status', {'auction_id': '{{auction_id}}'});
// }, 5000);

// socket.on('auction_status', function(data){
// 	console.log(data);
// });




socket.on("remaining_time", function(seconds){
	const formatted = moment.utc(seconds*1000).format('HH:mm:ss');
	app.remainingTime = formatted;
});

socket.on("update_view", function(data){
	console.log("updating view ...");
	console.log(data);
	app.currentOfferPrice = data['current_offer_price'];
	app.users = data.users[0];
	app.active_user = app.users[0];

	app.users.forEach(user => {
		app.people.push({
			name: user.username,
			its_you: user.id == "{{current_user.id}}" ? true : false,
			avatar: user.avatar ? avatar_path + ClearifyNames(user.avatar)[0] : "#",
			price: ToPersian(formatCurrency(user.current_offer_price))
		});
	});

	// TODO: update the dom

});

socket.on("unauthorized", function(data){
	console.log("unauthorized");
});

socket.on("failed", function(data){
	console.log("failed");
});

socket.on('accepted', function(data){
	app.users = data.users[0];
	app.winnerUser = app.users[0];
	app.offerBidCount = data.users[0].filter((user)=>{return user.id == "{{current_user.id}}"})[0].current_bids;

	
	app.auctionCurrentOffer = data['total_price']

	if (app.winnerUser){
		app.auctionCurrentWinner = data.users[0][0].username;
     	app.auctionCurrentWinnerImage = data.users[0][0].avatar ? avatar_path+ClearifyNames(data.users[0][0].avatar)[0] : "#";


	}

	console.log("accepted");



});


socket.on("auction_done", function(data){
 console.log("auction end");
});

</script>

{% endblock scripts %}
