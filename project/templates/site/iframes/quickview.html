{% extends 'site/iframes/ilayout.html' %}
{% block title %} بید بازی | شرکت در حراجی {% endblock %}
{% block content %}
<input type="hidden" id="auction" value="{{auction_id}}">
<div class="content-page">
  <div class="container">
    <div class="product-quickview detail-with-sidebar config-detail ">
      <div class="row">
        <div class="col-md-4 col-sm-5 col-xs-12">
          <div class="product-extra-link2 rightList">
            <a class="wishlist-link" href="#"><i aria-hidden="true" class="fa fa-times" data-bind="text:auction_rate">ضریب</i></a>
            <a class="wishlist-link" href="#"><i aria-hidden="true" class="fa fa-users"></i><span  data-bind="text: participant_count"></span> از <span data-bind="text: max_members"></span></a>
          </div>
          <!-- End rightlist -->
          <div class="detail-gallery">
            <div class="mid">
              <img data-bind="attr:{src: active_image}" alt=""/>
            </div>
            <div class="gallery-control">
              <a href="#" class="prev"><i class="fa fa-angle-left"></i></a>

              <div class="carousel">
                <ul data-bind="foreach: images">
                  <li><a href="#"><img data-bind="attr:{src: url}" alt=""/></a></li>
                </ul>
              </div>

              <a href="#" class="next"><i class="fa fa-angle-right"></i></a>
            </div>
          </div>
          <!-- End Gallery -->
          <div class="detail-without-sidebar">
            <div class="detail-social">
              <ul class="list-social-detail list-inline-block">
                <li><a href="#" class="soci-fa soc-tumblr"><i class="fa fa-tumblr" aria-hidden="true"></i></a></li>
                <li><a href="#" class="soci-fa soc-facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                <li><a href="#" class="soci-fa soc-twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                <li><a href="#" class="soci-fa soc-print"><i class="fa fa-print" aria-hidden="true"></i></a></li>
                <li>
                  <div class="more-social">
                    <a class="soci-fa add-link soc-add" href="#"><i aria-hidden="true" class="fa fa-plus"></i><span>7</span></a>
                    <ul class="list-social-share list-none">
                      <li><a href="#"><i class="fa fa-youtube" aria-hidden="true"></i><span>Youtute</span></a></li>
                      <li><a href="#"><i class="fa fa-linkedin"></i><span>linkedin</span></a></li>
                      <li><a href="#"><i class="fa fa-pinterest"></i><span>pinterest</span></a></li>
                      <li><a href="#"><i class="fa fa-google"></i><span>google</span></a></li>
                      <li><a href="#"><i class="fa fa-instagram"></i><span>instagram</span></a></li>
                      <li><a href="#"><i class="fa fa-flickr"></i><span>flickr</span></a></li>
                      <li><a href="#"><i class="fa fa-reddit"></i><span>reddit</span></a></li>
                    </ul>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-8 col-sm-7 col-xs-12">
          <div class="detail-info">
            <h2 class="title-detail" data-bind="text: auction_title"></h2>
            <div class="product-price">
              <!-- <a href="#" class="shopnow"><span>شرکت در حراجی</span></a> -->
              <div class="textboX">
                <div class="textboXX"><p id="auction_item_price"> قیمت محصول : <span data-bind="text: auction_item_price"></span> تومان </p></div>
                <div class="upArrow"></div>
              </div>
              <div class="textboX">
                <div class="textboXX"><p id="auction_register_price">شروع حراجی : <span data-bind="text: auction_register_price"></span></p></div>
                <div class="upArrow"></div>
              </div>
            </div>
            <div class="detail-extralink">
              <div class="list-member-bid" data-bind="foreach: people">
                <p class="item-Bid" data-bind="css: { 'YOU' : its_me  }"><img data-bind="attr:{src: avatar}"/>
                  <sd data-bind="text:name"></sd>
                    <span>۲</span>
                    <b>۱،۵۶۷،۰۰۰ تومان</b>
                  </p>

                <!-- <p class="item-Bid"><img src="images/theme/005.png"/>احسان امینی<span>۱</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/004.png"/>امیرحسین امینی<span>۲</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/005.png"/>پوریا نصیری پور<span>۳</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/005.png"/>امید ابراهیمی<span>۴</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/004.png"/>کاوه رضایی<span>۵</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid YOU"><img src="images/theme/005.png"/>سید حسین حسینی<span>۶</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/004.png"/>سید مهدی رحمتی<span>۷</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/005.png"/>روزبه چشمی<span>۸</span><b>۱،۵۶۷،۰۰۰ تومان</b></p>
                <p class="item-Bid"><img src="images/theme/004.png"/>فرمانده<span>۹</span><b>۱،۵۶۷،۰۰۰ تومان</b></p> -->
              </div>
              <div class="product-extra-link2">
                <div class="last-Bid-user">
                  <p class="img-price-Bid"><img src="images/theme/005.png"/></p>
                  <p class="price-Bid"><span id="auction_current_offer"></span> تومان</p>
                  <p class="name-price-Bid" id="auction_current_winner"></p>
                </div>
                <input type="hidden" id="set-time" value="1"/>
                <div id="countdown">
                  <div id='tiles' class="color-full"></div>
                  <div class="countdown-label" data-bind="text:now_date"></div>
                </div>
                <a class="addcart-link" href="#" id="offer">پیشنهاد <div class="detail-qty border radius" id="offer_count">۰</div></a>
              </div>
              <div class="detail-countdowns"><span>تاریخ اتمام حراجی : </span>
                <div data-bind="text:auction_end_date">
                </div>
                <i aria-hidden="true" class="fa fa-clock-o"></i> ساعت: <span data-bind="text:auction_end_time"></span>
              </div>
            </div>
            <div class="detail-extralink mt-0">
              <div class="product-extra-link2">
                <a class="addcart-link2" href="#"><i class="fa fa-shopping-basket" aria-hidden="true" id="add_to_bag"></i> اضافه به سبد</a>
                <a class="wishlist-link2" href="#" id="like_auction"><i aria-hidden="true" class="fa fa-heart"></i></a>
                <a class="wishlist-link2 text-red" href="#"><i aria-hidden="true" class="fa fa-percent"></i>۲،۴۵۰،۰۰۰ تومان</a>
              </div>
            </div>
          </div>
          <!-- Detail Info -->
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}

<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/owl.carousel.js')}} "></script>
<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/jquery.jcarousellite.js')}} "></script>
<script type="text/javascript" src=" {{ url_for('static',filename='js/libs/jquery.elevatezoom.js')}} "></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/libs/knockout.js')}}"></script>
<script type="text/javascript" src="{{url_for('static',filename='js/socket/reconnecting-websocket.min.js')}}"></script>

<script>
var auction_id = $('#auction').val();
var images_path = '../../static/images/products/';
var avatar_path = '../../static/images/avatars/';
var end_time = null;

$.getJSON( "/api/auction/"+auction_id+"/instantview", function( data ) {

  data = data[0];

  var deadline = new Date(data.start_date).format("yyyy-M-d hh:mm:ss TT","UTC");
  var event = new Date(Date.parse(deadline));
  var end_day = event.toLocaleDateString('fa-IR', {day:'numeric'});
  var end_weekday = event.toLocaleDateString('fa-IR', {weekday:'long'});
  var end_month = event.toLocaleDateString('fa-IR', {month:'long'});
  var today = new Date();
  var Christmas = new Date(deadline);
  end_time = (Christmas - today);

  var end_date_date = end_weekday + " " + end_day +" "+ end_month;
  var end_date_time = ToPersian(event.getHours());

  var event = new Date(Date.now());
  var now_day = event.toLocaleDateString('fa-IR', {day:'numeric'});
  var now_weekday = event.toLocaleDateString('fa-IR', {weekday:'long'});
  var now_month = event.toLocaleDateString('fa-IR', {month:'long'});

  var now_date_time = event.toLocaleTimeString('fa-IR');
  var now_date_date = now_weekday + " " + now_day +" "+ now_month;

  var participant_count = ToPersian(data.participants.length);
  var max_members = ToPersian(data.max_members);
  var images_temp = ClearifyNames( data.item.images);
  var images = [];

  $.each(images_temp, function(key,val) {
    images.push({url:images_path+val.trim(),active:false});
  });
  images[0].active=true;

  var participants = data.participants

  var people = [];
  var  current_user_id = '{{current_user.id}}';

  $.each(participants, function(key,val) {
    its_you = val.id == current_user_id ? true : false;
    name = val.first_name ? val.first_name +" "+ val.last_name : val.username ;
    p = {avatar : val.avatar ? avatar_path + ClearifyNames(val.avatar)[0] : "#",name : name ,its_me : its_you};
    people.push(p);
  });

  function MyViewModel() {
      this.participant_count = participant_count;
      this.max_members = max_members;
      this.images = images;
      this.active_image = images[0].url;
      this.auction_title = data.title;
      this.auction_item_price = ToPersian(formatCurrency(data.item.price));
      this.auction_register_price = ToPersian(formatCurrency(data.base_price));
      this.people = people;
      this.auction_rate = ToPersian(data.ratio);
      this.auction_end_date = end_date_date;
      this.auction_end_time = end_date_time;
      this.now_date = now_date_date;
  }
  ko.applyBindings(new MyViewModel());

  if($('.detail-gallery').length>0){
    $('.detail-gallery').each(function(){
      $(this).find(".carousel").jCarouselLite({
        btnNext: $(this).find(".gallery-control .next"),
        btnPrev: $(this).find(".gallery-control .prev"),
        speed: 800,
        visible:3,
      });
      //Elevate Zoom
      $(this).find('.mid img').elevateZoom({
        zoomType: "inner",
        cursor: "crosshair",
        zoomWindowFadeIn: 500,
        zoomWindowFadeOut: 750
      });

      $(this).find(".carousel a").on('click',function(event) {
        event.preventDefault();
        $(this).parents('.detail-gallery').find(".carousel a").removeClass('active');
        $(this).addClass('active');
        $(this).parents('.detail-gallery').find(".mid img").attr("src", $(this).find('img').attr("src"));
        var z_url = $(this).parents('.detail-gallery').find('.mid img').attr('src');
        $('.zoomWindow').css('background-image','url("'+z_url+'")');
      });
    });
  }

});

if (window.location.protocol == "https:") {
    var ws_scheme = "wss://";
    }
  else {
    var ws_scheme = "ws://"
};

var inbox = new ReconnectingWebSocket(ws_scheme + location.host + "/receive");
var outbox = new ReconnectingWebSocket(ws_scheme + location.host + "/submit");

inbox.onmessage = function(message) {
  console.log(message.data);
  var data = JSON.parse(message.data);
  if(data.success=='true'){
    $('#offer_count').html(ToPersian(data.total_bids));
    $('#auction_current_offer').html(ToPersian(formatCurrency(data.total_price)));
    $('#auction_current_winner').html(data.user);
    target_date += (10 * 1000);
    getCountdown();
  }
  else {
    alert(data.reason)
  }
};

inbox.onclose = function(){
    console.log('inbox closed');
    this.inbox = new WebSocket(inbox.url);
};

outbox.onclose = function(){
    console.log('outbox closed');
    this.outbox = new WebSocket(outbox.url);
};

$("#offer").on("click", function(event) {
  event.preventDefault();
  outbox.send(JSON.stringify({ user_id: '{{current_user.id}}', auction_id: auction_id }));
});

//************************************************countdown*****************************

//countdown
var minutes = $( '#set-time' ).val();

var target_date = new Date().getTime() + ((minutes * 70 ) * 1000); // set the countdown date
var time_limit = ((minutes * 70 ) * 1000);

//set actual timer
setTimeout(
function()
{
  alert( 'حراجی به پایان رسید!' );
}, time_limit );

var days, hours, minutes, seconds; // variables for time units

var countdown = document.getElementById("tiles"); // get tag element

getCountdown();

setInterval(function () { getCountdown(); }, 1000);

function getCountdown(){

  // find the amount of "seconds" between now and target
  var current_date = new Date().getTime();
  var seconds_left = (target_date - current_date) / 1000;

  if ( seconds_left >= 0 ) {
  console.log(time_limit);
   if ( (seconds_left * 1000 ) < ( time_limit / 1 ) )  {
     $( '#tiles' ).removeClass('color-full');
     $( '#tiles' ).addClass('color-half');

      }
    if ( (seconds_left * 1000 ) < ( time_limit / 6 ) )  {
      $( '#tiles' ).removeClass('color-half');
      $( '#tiles' ).addClass('color-empty');
    }

  days = pad( parseInt(seconds_left / 86400) );
  seconds_left = seconds_left % 86400;

  hours = pad( parseInt(seconds_left / 3600) );
  seconds_left = seconds_left % 3600;

  minutes = pad( parseInt(seconds_left / 60) );
  seconds = pad( parseInt( seconds_left % 60 ) );

  // format countdown string + set tag value
  countdown.innerHTML = "<span>" + hours + ":</span><span>" + minutes + ":</span><span>" + seconds + "</span>";
  }
}

function pad(n) {
  return (n < 10 ? '0' : '') + n;
}

</script>

{% endblock scripts %}
