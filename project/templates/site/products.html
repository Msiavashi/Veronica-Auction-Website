{% extends 'site/layout.html' %}
{% block title %} بیدبازی | دسته بندی ها {% endblock %}
{% block content %}
<div class="content-page page-product-hot-deal">
	<div class="container" id="app">
		<div v-if="ads">
			<div class="boxed-slider radius">
				<div class="wrap-item" data-itemscustom="[[0,1]]" data-pagination="false" data-navigation="true">
					<template v-for="item in ads">
						{%raw%}
						<div class="banner-shop">
							<div class="banner-shop-thumb">
								<a href="#"><img v-bind:src="prepare_ad_images(item.advertisement.images)"></a>
							</div>
							<div class="banner-shop-info text-left">
								<h2><a href="#">{{item.advertisement.title}}</a></h2>
								<p class="title30 color">تخفیف : تا {{_ToPersian(item.advertisement.discount)}}٪ قیمت </p>
								<a v-bind:href= "'/view/auction/'+item.id" class="btn-rect diswe white bg-color radius">{{item.advertisement.link_title}}</a>
							</div>
						</div>
						{%endraw%}
					</template>
				</div>
			</div>
		</div>

		<!-- End Banner -->

		<div class="bread-crumb radius">
			<a href="/">خانه</a><span>{%raw%}{{category_title}}{%endraw%}</span>
		</div>

		<!-- End Bread Crumb -->

		<div class="sort-pagi-bar clearfix">
			<div class="pull-left">
				<div class="sort-bar select-box">
					<label>مرتب سازی بر اساس:</label>
					<select v-model="ordering" v-on:change="orderBy">
						<option value="price">قیمت</option>
						<option value="time">زمان</option>
					</select>
				</div>
			</div>
			<div class="pull-right">
				<div class="show-bar select-box">
					<label>تعداد:</label>
					<select v-model="sortingTotal" v-on:change="sortByTotal">
						<option value="5">۵</option>
						<option value="10">۱۰</option>
						<option value="15">۱۵</option>
					</select>
				</div>
			</div>
		</div>

		<!-- End Sort PagiBar -->

		<div class="list-product-hot-deal">
			<div class="row">

				<template v-for="auction in auctions">
					<div class="col-md-3 col-sm-4 col-xs-12">
					{%raw%}
					<div class="item-product item-pro-hotdeal">
						<div class="deal-clock bg-color">
							<span>زمان باقیمانده: </span>
							<div v-flashtimer class="flash-countdown timer" v-bind:data-timer ="auction.remained_time"></div>
						</div>
						<div class="product-thumb">
							<a href="#" class="product-thumb-link">
								<img v-bind:src="auction.image" alt="">
							</a>
							<a v-bind:href = "auction.instantview_link" class="quickview-link plus fancybox.iframe"><span>مشاهده سریع</span></a>

							<div class="product-extra-link">
								<a class="addcart-link" href="#" v-on:click="addToCart(auction.item_id,$event)"><i aria-hidden="true" class="fa fa-shopping-basket"></i></a>
								<a href="#" v-on:click="addToWish(auction.id,$event)" class="wishlist-link"><input type="hidden" v-bind:value = "auction.id"><i class="fa fa-heart" aria-hidden="true"></i></a>
							</div>
						</div>
						<div class="product-info">
							<h3 class="product-title"><a v-bind:href="auction.auctionview_link">{{auction.title}}</a></h3>
							<div class="info-pro-hotdeal">
								<div class="deal-percent">
									<span>شروع حراجی:</span>
									<span>{{auction.base_price}}</span>
								</div>
								<div class="product-price">
									<del><span>قیمت محصول</span></del>
									<ins><span>{{auction.price}}</span> تومان </ins>
								</div>
								<div class="store-process">
									<div class="percent-store" v-bind:style="auction.remained_percent"></div>
									<span class="product-instock">{{_ToPersian(auction.remained_time)}} ثانیه</span>
								</div>
							</div>
						</div>

					</div>
					{%endraw%}
					</div>
				</template>

			</div>

		</div>


		<!-- <div class="btn-loadmore"><a href="#"><i aria-hidden="true" class="fa fa-spinner fa-spin"></i></a></div> -->

		<!-- <div><i aria-hidden="true" class="fa fa-spinner fa-spin"></i></div>
		element.style {
    border: 1px dashed;
    text-align: center;
    opacity: 90;
    margin: 0px;
    padding: 0px;
    background: #ddd;
    /* width: auto; */
    /* height: 100px; */
    padding: 50px;
    position: relative;
    /* align-content: center; */
		} -->
	</div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>

	start_loading(loading_element);

	app = new Vue({

		el : "#app",

		data:{
			ads : [],
			auctions : [] ,
			category_title : " دسته بندی ",
			order_by_index : 0,
			total_index : 0,
			interval:null,
			sortingTotal :"5",
			ordering :"price",
		},
		methods:{
			prepare_ad_images(images){
				return ad_image_path + ClearifyNames(images)[0];
			},
			_ToPersian(number){
				return ToPersian(number);
			},

			sortByTotal: function() {
	        start_loading(loading_element);
					this.auctions = []
					var vm = this;
					axios.get("/api/site/category/{{category_id}}/product/filters/"+this.ordering+"/"+this.sortingTotal+"")
						.then((response) => {
							response.data.auctions[0].forEach(auction => {
								this.auctions.push({
									id : auction.id,
									title : auction.title ,
									description : auction.description ,
									remained_time : auction.remained_time,
									from_created : auction.left_from_created,
									remained_percent : "width:0%",
									base_price : ToPersian(formatCurrency(auction.base_price)),
									max_price : ToPersian(formatCurrency(auction.max_price)),
									price : ToPersian(formatCurrency(auction.item.price)),
									image : product_image_path + ClearifyNames(auction.item.images)[0],
									instantview_link : "/instantview/"+ auction.id,
									auctionview_link : "/view/auction/"+ auction.id,
									item_id : auction.item.id,
									likes : auction.likes
								});
							});

							stop_loading(loading_element);
						})
						.catch((response)=>{
							console.error(response);
						});
	    },

			orderBy: function() {
	        start_loading(loading_element);
					this.auctions = []
					var vm = this;
					axios.get("/api/site/category/{{category_id}}/product/filters/"+this.ordering+"/"+this.sortingTotal+"")
						.then((response) => {
							response.data.auctions[0].forEach(auction => {
								this.auctions.push({
									id : auction.id,
									title : auction.title ,
									description : auction.description ,
									remained_time : auction.remained_time,
									from_created : auction.left_from_created,
									remained_percent : "width:0%",
									base_price : ToPersian(formatCurrency(auction.base_price)),
									max_price : ToPersian(formatCurrency(auction.max_price)),
									price : ToPersian(formatCurrency(auction.item.price)),
									image : product_image_path + ClearifyNames(auction.item.images)[0],
									instantview_link : "/instantview/"+ auction.id,
									auctionview_link : "/view/auction/"+ auction.id,
									item_id : auction.item.id,
									likes : auction.likes
								});
							});

							stop_loading(loading_element);
						})
						.catch((response)=>{
							console.error(response);
						});
	    },

			addToCart:function(item_id,event){
				event.preventDefault();
				axios.post("{{url_for('usercartorder')}}",
					{
						"item_id": item_id,
						"total":1
					},
					{
						headers:
						{
							'Content-Type': 'application/json'
						}
					}).then((response) => {
						if(response.data.length > 0){
							myapp.mycarts = []
							console.log(response.data);
							response.data.forEach(cart => {
								myapp.mycarts.push({
	                id : cart[0].id,
	                item_title : cart[0].item.title,
									product_title : cart[0].item.product.title,
									item_id : cart[0].item.id ,
	                image : '/static/images/products/' + ClearifyNames(cart[0].item.images)[0],
	                discounted_price : cart[0].item.price - cart[0].item.discount,
									main_price : cart[0].item.price ,
	                min_quantity : 1,
	                max_quantity : cart[0].item.quantity,
	                current_quantity : cart[0].total,
								});
							});
	            myapp.total_carts = ToPersian(myapp.mycarts.length);
							myapp.total_changed = true;
							alert('محصول مورد نظر شما به سبد خرید اضافه شد');

						}
					})
					.catch((error)=>{
						alert(error.response.data.reason);
					});
			},

			addToWish:function(auction_id,event){
				event.preventDefault();
				axios.post("{{url_for('userauctionlikes')}}",
					{
						"auction_id": auction_id
					},
					{
						headers:
						{
							'Content-Type': 'application/json'
						}
					}).then((response) => {
							alert('محصول موردنظر به علاقمندی های شما اضافه شد');
					})
					.catch((error)=>{
						alert(error.response.data.message);
					});
			}

		},
		mounted: function(){
			var vm = this;
			axios.get("/api/site/category/{{category_id}}/product/filters/"+this.ordering+"/"+this.sortingTotal+"")
				.then((response) => {
					response.data.auctions[0].forEach(auction => {
						this.auctions.push({
							id : auction.id,
							title : auction.title ,
							description : auction.description ,
							remained_time : auction.remained_time,
							from_created : auction.left_from_created,
							remained_percent : "width:0%",
							base_price : ToPersian(formatCurrency(auction.base_price)),
							max_price : ToPersian(formatCurrency(auction.max_price)),
							price : ToPersian(formatCurrency(auction.item.price)),
							image : product_image_path + ClearifyNames(auction.item.images)[0],
							instantview_link : "/instantview/"+ auction.id,
							auctionview_link : "/view/auction/"+ auction.id,
							item_id : auction.item.id,
							likes : auction.likes
						});
					});

					this.category_title = response.data.category[0].title;
				})
				.catch((response)=>{
					console.error(response);
				});

			axios.get("{{url_for('sitecategorycarouselads',cid=category_id)}}")
				.then((response) => {
					this.ads = response.data[0];
				})
				.catch((response)=>{
					console.error(response);
				});

			this.interval = setInterval(()=>{
				this.auctions.forEach(auction => {
					auction.remained_time -= 1;
					auction.remained_percent = "width:"+ (auction.remained_time / auction.from_created)*100+"%";
				});
			}, 1000);
		},

		updated:function() {
			stop_loading(loading_element);
		},

		directives: {

			flashtimer:{
				inserted:function(el) {

					if($('.flash-countdown').length>0){
						$(".flash-countdown").TimeCircles({
							fg_width: 0.01,
							bg_width: 1.2,
							text_size: 0.07,
							circle_bg_color: "#ffffff",
							time: {
								Days: {
									show: true,
									text: "",
									color: "#f9bc02"
								},
								Hours: {
									show: true,
									text: "",
									color: "#f9bc02"
								},
								Minutes: {
									show: true,
									text: "",
									color: "#f9bc02"
								},
								Seconds: {
									show: true,
									text: "",
									color: "#f9bc02"
								}
							}
						});
					}

				}
			},

		}

	});

</script>
{% endblock scripts %}
