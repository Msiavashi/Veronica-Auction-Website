{% extends 'site/layout.html' %}
{% block title %} بیدبازی | دسته بندی ها {% endblock %}
{% block content %}
<input type="hidden" id="category" value="{{category_id}}">

<div class="content-page page-product-hot-deal">
	<div class="container" id="app">
		<div class="boxed-slider radius">
			<div class="wrap-item" data-itemscustom="[[0,1]]" data-pagination="false" data-navigation="true">
				<template v-for="auction in ads">
					{%raw%}
					<div class="banner-shop">
						<div class="banner-shop-thumb">
							<a href="#"><img v-bind:src="prepare_ad_images(auction.advertisement.images)"></a>
						</div>
						<div class="banner-shop-info text-left">
							<h2><a href="#">{{auction.advertisement.title}}</a></h2>
							<p class="title30 color">تخفیف: <span>تا </span> <span>{{_ToPersian(auction.advertisement.discount)}}</span> ٪ <span> قیمت</span></p>
							<a v-bind:href= "'/view/auction/'+auction.id" class="btn-rect diswe white bg-color radius">{{auction.advertisement.link_title}}</a>
						</div>
					</div>
					{%endraw%}
				</template>
			</div>

		</div>

		<!-- End Banner -->

		<div class="bread-crumb radius">
			<a href="/">خانه</a><span>{%raw%}{{category_title}}{%endraw%}</span>
		</div>

		<!-- End Bread Crumb -->

		<div class="sort-pagi-bar clearfix">
			<div class="pull-left">
				<div class="sort-bar select-box">
					<label>مرتب سازی بر اساس:</label>
					<select v-model="ordering" v-on:change="orderBy">
						<option value="price">قیمت</option>
						<option value="time">زمان</option>
					</select>
				</div>
			</div>
			<div class="pull-right">
				<div class="show-bar select-box">
					<label>تعداد:</label>
					<select v-model="sortingTotal" v-on:change="sortByTotal">
						<option value="5">۵</option>
						<option value="10">۱۰</option>
						<option value="15">۱۵</option>
					</select>
				</div>
			</div>
		</div>

		<!-- End Sort PagiBar -->

		<div class="list-product-hot-deal">
			<div class="row">

				<template v-for="auction in auctions">
					<div class="col-md-3 col-sm-4 col-xs-12">
					{%raw%}
					<div class="item-product item-pro-hotdeal">
						<div class="deal-clock bg-color">
							<span>زمان باقیمانده: </span>
							<div v-flashtimer class="flash-countdown timer" v-bind:data-timer ="auction.remained_time"></div>
						</div>
						<div class="product-thumb">
							<a href="#" class="product-thumb-link">
								<img v-bind:src="auction.image" alt="">
							</a>
							<a v-bind:href = "auction.instantview_link" class="quickview-link plus fancybox.iframe"><span>مشاهده سریع</span></a>

							<div class="product-extra-link">
								<a class="addcart-link" href="#"><input type="hidden" v-bind:value = "auction.item_id"><i aria-hidden="true" class="fa fa-shopping-basket"></i></a>
								<a href="#" class="wishlist-link"><input type="hidden" v-bind:value = "auction.id"><i class="fa fa-heart" aria-hidden="true"></i></a>
							</div>
						</div>
						<div class="product-info">
							<h3 class="product-title"><a v-bind:href="auction.auctionview_link">{{auction.title}}</a></h3>
							<div class="info-pro-hotdeal">
								<div class="deal-percent">
									<span>شروع حراجی:</span>
									<span>{{auction.base_price}}</span>
								</div>
								<div class="product-price">
									<del><span>قیمت محصول</span></del>
									<ins><span>{{auction.price}}</span> تومان </ins>
								</div>
								<div class="store-process">
									<div class="percent-store" v-bind:style="auction.remained_percent"></div>
									<span class="product-instock">{{_ToPersian(auction.remained_time)}} ثانیه</span>
								</div>
							</div>
						</div>

					</div>
					{%endraw%}
					</div>
				</template>

			</div>

		</div>


		<!-- <div class="btn-loadmore"><a href="#"><i aria-hidden="true" class="fa fa-spinner fa-spin"></i></a></div> -->

		<!-- <div><i aria-hidden="true" class="fa fa-spinner fa-spin"></i></div>
		element.style {
    border: 1px dashed;
    text-align: center;
    opacity: 90;
    margin: 0px;
    padding: 0px;
    background: #ddd;
    /* width: auto; */
    /* height: 100px; */
    padding: 50px;
    position: relative;
    /* align-content: center; */
		} -->
	</div>
</div>


{% endblock %}
{% block scripts %}
{{ super() }}

<script>
start_loading(loading_element);

app = new Vue({

	el : "#app",

	data:{
		ads : [],
		auctions : [] ,
		category_title : " دسته بندی ",
		order_by_index : 0,
		total_index : 0,
		interval:null,
		sortingTotal :"5",
		ordering :"price",
	},

	methods:{
		prepare_ad_images(images){
			return ad_image_path + ClearifyNames(images)[0];
		},
		_ToPersian(number){
			return ToPersian(number);
		},
		installOwlCarousel: function(element){
			$('.wrap-item').each(function(){

				var data = $(this).data();
				$(this).owlCarousel({
					addClassActive:true,
					stopOnHover:true,
					itemsCustom:data.itemscustom,
					autoPlay:data.autoplay,
					transitionStyle:data.transition,
					beforeInit:background,
					afterAction:animated,
					navigationText:['<i class="fa fa-angle-left" aria-hidden="true"></i>','<i class="fa fa-angle-right" aria-hidden="true"></i>'],
				});
				$(this).find('.owl-controls').css('left',data.control+'px');
			});
		},

		sortByTotal: function() {
        start_loading(loading_element);
				this.auctions = []
				var vm = this;
				axios.get("/api/site/category/{{category_id}}/product/filters/"+this.ordering+"/"+this.sortingTotal+"")
					.then((response) => {
						response.data.auctions[0].forEach(auction => {
							this.auctions.push({
								id : auction.id,
								title : auction.title ,
								description : auction.description ,
								remained_time : auction.remained_time,
								from_created : auction.left_from_created,
								remained_percent : "width:0%",
								base_price : ToPersian(formatCurrency(auction.base_price)),
								max_price : ToPersian(formatCurrency(auction.max_price)),
								price : ToPersian(formatCurrency(auction.item.price)),
								image : product_image_path + ClearifyNames(auction.item.images)[0],
								instantview_link : "/instantview/"+ auction.id,
								auctionview_link : "/view/auction/"+ auction.id,
								item_id : auction.item.id,
								likes : auction.likes
							});
						});

						Vue.nextTick(function(){
							vm.installOwlCarousel();
						}.bind(vm));
						stop_loading(loading_element);
					})
					.catch((response)=>{
						console.log(response);
					});
    },

		orderBy: function() {
        start_loading(loading_element);
				this.auctions = []
				var vm = this;
				axios.get("/api/site/category/{{category_id}}/product/filters/"+this.ordering+"/"+this.sortingTotal+"")
					.then((response) => {
						response.data.auctions[0].forEach(auction => {
							this.auctions.push({
								id : auction.id,
								title : auction.title ,
								description : auction.description ,
								remained_time : auction.remained_time,
								from_created : auction.left_from_created,
								remained_percent : "width:0%",
								base_price : ToPersian(formatCurrency(auction.base_price)),
								max_price : ToPersian(formatCurrency(auction.max_price)),
								price : ToPersian(formatCurrency(auction.item.price)),
								image : product_image_path + ClearifyNames(auction.item.images)[0],
								instantview_link : "/instantview/"+ auction.id,
								auctionview_link : "/view/auction/"+ auction.id,
								item_id : auction.item.id,
								likes : auction.likes
							});
						});

						Vue.nextTick(function(){
							vm.installOwlCarousel();
						}.bind(vm));
						stop_loading(loading_element);
					})
					.catch((response)=>{
						console.log(response);
					});
    },

	},
	mounted: function(){
		var vm = this;
		axios.get("/api/site/category/1/product/filters/price/10")
			.then((response) => {
				response.data.auctions[0].forEach(auction => {
					this.auctions.push({
						id : auction.id,
						title : auction.title ,
						description : auction.description ,
						remained_time : auction.remained_time,
						from_created : auction.left_from_created,
						remained_percent : "width:0%",
						base_price : ToPersian(formatCurrency(auction.base_price)),
						max_price : ToPersian(formatCurrency(auction.max_price)),
						price : ToPersian(formatCurrency(auction.item.price)),
						image : product_image_path + ClearifyNames(auction.item.images)[0],
						instantview_link : "/instantview/"+ auction.id,
						auctionview_link : "/view/auction/"+ auction.id,
						item_id : auction.item.id,
						likes : auction.likes
					});
				});

				this.category_title = response.data.category[0].title;

				Vue.nextTick(function(){
					vm.installOwlCarousel();
				}.bind(vm));

			})
			.catch((response)=>{
				console.log(response);
			});

		axios.get("{{url_for('sitecategorycarouselads',cid=category_id)}}")
			.then((response) => {
				console.log(response.data[0]);
				this.ads = response.data[0];
			})
			.catch((response)=>{
				console.log(response);
			});

			this.interval = setInterval(()=>{
				this.auctions.forEach(auction => {
					auction.remained_time -= 1;
					auction.remained_percent = "width:"+ (auction.remained_time / auction.from_created)*100+"%";
				});
			}, 1000);
	},
	updated:function() {
		stop_loading(loading_element);
	},

	directives: {
		carousel: {
			inserted: function (el) {

				//Owl Carousel
				if($('.wrap-item').length>0){
					$('.wrap-item').each(function(){
						var data = $(this).data();
						$(this).owlCarousel({
							addClassActive:true,
							stopOnHover:true,
							itemsCustom:data.itemscustom,
							autoPlay:data.autoplay,
							transitionStyle:data.transition,
							beforeInit:background,
							afterAction:animated,
							navigationText:['<i class="fa fa-angle-left" aria-hidden="true"></i>','<i class="fa fa-angle-right" aria-hidden="true"></i>'],
						});
						$(this).find('.owl-controls').css('left',data.control+'px');
					});
				}
				//BxSlider
				if($('.bxslider-banner').length>0){
					$('.bxslider-banner').each(function(){
						$(this).find('.bxslider').bxSlider({
							controls:false,
							pagerCustom: $(this).find('.bx-pager')
						});
					});
				}
				//Detail Gallery Widthout sidebar
				if($('.gallery-without-sidebar').length>0){
					$('.gallery-without-sidebar').each(function(){
						if($(window).width()>1200){
							$(this).find('.carousel').flexslider({
								animation: "slide",
								controlNav: false,
								animationLoop: false,
								slideshow: false,
								itemWidth: 80,
								minItems: 6,
								maxItems: 6,
								move: 1,
								direction: "vertical",
								directionNav: false,
								asNavFor: $(this).find('.slider')
							});
							$(this).find('.slider').flexslider({
								animation: "slide",
								controlNav: false,
								animationLoop: false,
								slideshow: false,
								prevText: '<i class="fa fa-angle-left"></i>',
								nextText: '<i class="fa fa-angle-right"></i>',
								sync: $(this).find('.carousel')
							});
						}else{
							$(this).find('.carousel').flexslider({
								animation: "slide",
								controlNav: false,
								animationLoop: false,
								slideshow: false,
								itemWidth: 80,
								minItems: 3,
								maxItems: 6,
								move: 1,
								direction: "horizontal",
								directionNav: false,
								asNavFor: $(this).find('.slider')
							});
							$(this).find('.slider').flexslider({
								animation: "slide",
								controlNav: false,
								animationLoop: false,
								slideshow: false,
								prevText: '<i class="fa fa-angle-left"></i>',
								nextText: '<i class="fa fa-angle-right"></i>',
								sync: $(this).find('.carousel')
							});
						}
					});
				}

			},
		},
		flashtimer:{
			inserted:function(el) {
				console.log("timer inserted");
				if($('.flash-countdown').length>0){
					$(".flash-countdown").TimeCircles({
						fg_width: 0.01,
						bg_width: 1.2,
						text_size: 0.07,
						circle_bg_color: "#ffffff",
						time: {
							Days: {
								show: true,
								text: "",
								color: "#f9bc02"
							},
							Hours: {
								show: true,
								text: "",
								color: "#f9bc02"
							},
							Minutes: {
								show: true,
								text: "",
								color: "#f9bc02"
							},
							Seconds: {
								show: true,
								text: "",
								color: "#f9bc02"
							}
						}
					});
				}

			}

		}
	}


});


$(document).on('click','.addcart-link',function(event) {
	self = $(this);
	item_id = parseInt(self.find('input').val());

	var data = JSON.stringify({
  	"item_id": item_id,
		"total":1
	});

	var xhr = new XMLHttpRequest();
	xhr.withCredentials = true;

	xhr.open("POST", "{{url_for('usercartorder')}}");
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.setRequestHeader("Cache-Control", "no-cache");
	xhr.send(data);
	xhr.onreadystatechange = function (oEvent) {
    if (xhr.readyState === 4) {
				data = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
					carts = []
			    $.each(data,function(key,val) {
						if(val[0])
				      carts.push(val[0]);
			    });
			    console.log(carts);
			    mycart(carts);
			    total_carts(ToPersian(carts.length));
					alert('محصول مورد نظر شما به سبد خرید اضافه شد')
        } else {
           alert(data.reason)
        }
    	}
		};
	});

$(document).on('click','.wishlist-link',function(event) {
	self = $(this);

	var data = JSON.stringify({
  	"auction_id": parseInt(self.find('input').val()),
	});


	var xhr = new XMLHttpRequest();
	xhr.withCredentials = true;

	xhr.open("POST", "{{url_for('userauctionlikes')}}");
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.setRequestHeader("Cache-Control", "no-cache");
	xhr.send(data);
	xhr.onreadystatechange = function (oEvent) {
    if (xhr.readyState === 4) {
				data = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
					console.log(data);
					console.log('success');
        } else {
				console.log(data);
				 console.log('error');
				 alert(data.message)
        }
    	}
		};
	});

</script>
{% endblock scripts %}
