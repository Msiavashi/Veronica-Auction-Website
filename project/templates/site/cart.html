{% extends 'site/layout.html' %}
{% block title %} بردیتو | سبد خرید  {% endblock %}
{% block content %}
<div class="content-page woocommerce">
	<div class="container">
		<div class="cart-content-page">
			<h2 class="title-shop-page">سبد خرید من</h2>
			<form method="post">
				<div class="table-responsive">
					<table cellspacing="0" class="shop_table cart table">
						<thead>
							<tr>
								<th class="product-remove">&nbsp;</th>
								<th class="product-thumbnail">&nbsp;</th>
								<th class="product-name">محصولات</th>
								<th class="product-price">قیمت</th>
								<th class="product-quantity">تعداد</th>
								<th class="product-subtotal">کل</th>
							</tr>
						</thead>

						<tbody data-bind="foreach:mycart">
							<tr class="cart_item">
								<td class="product-remove">
									<a class="remove" href="#"><input type="hidden" data-bind="attr:{value:item.id}"><i class="fa fa-times"></i></a>
								</td>
								<td class="product-thumbnail">
									<a href="#"><img  data-bind="attr:{src: product_image_path + ClearifyNames(item.images)[0] }" /></a>
								</td>
								<td class="product-name">
									<a href="#" data-bind="text:item.product.title+' '+item.title">f</a>
								</td>
								<td class="product-price">
									<span class="amount" data-bind="text:ToPersian(formatCurrency(item.price - item.discount))"></span> تومان
								</td>
								<td class="product-quantity">
									<div class="detail-qty border radius">
										<a href="#" class="qty-down"><i class="fa fa-caret-down" aria-hidden="true"></i></a>
										<span class="qty-val" data-bind="text:total"></span>
										<a href="#" class="qty-up"><i class="fa fa-caret-up" aria-hidden="true"></i></a>
									</div>
								</td>
								<td class="product-subtotal">
									<span class="amount">۴،۰۰۰،۰۰۰ تومان</span>
								</td>
							</tr>
							<!-- ko text: triggerUpDownCart() -->
							<!-- /ko -->

						</tbody>
						<tr>
							<td class="actions" colspan="6">
								<div class="coupon">
									<label for="coupon_code">کد تخفیف: </label>
									<input type="text" placeholder="کد ۵ حرفی" value="" id="coupon_code" class="input-text" name="coupon_code">
									<input type="submit" value="درخواست" name="apply_coupon" class="button">
								</div>
								<input type="submit" value="به روزرسانی سبد" name="update_cart" class="button">
							</td>
						</tr>
					</table>
				</div>
			</form>

			<div class="cart-collaterals">
				<div class="cart_totals ">
					<h2>مجموع پرداختی</h2>
					<div class="table-responsive">
						<table cellspacing="0" class="table">
							<tbody>
								<tr class="cart-subtotal">
									<th>کل مبلغ سفارش</th>
									<td><strong class="amount">۴،۹۰۰،۰۰۰ تومان</strong></td>
								</tr>
								<tr class="cart-subtotal">
									<th class="text-orange">تخفیف داده شده (کد تخفیف)</th>
									<td><strong class="amount text-orange">۴۰،۰۰۰ تومان</strong></td>
								</tr>
								<tr class="cart-subtotal">
									<th class="text-orange">تخفیف داده شده (محصول)</th>
									<td><strong class="amount text-orange">۲،۰۰۰،۰۰۰ تومان</strong></td>
								</tr>
								<tr class="order-total">
									<th>مبلغ پرداختی نهایی</th>
									<td><strong><span class="amount">۲،۹۰۰،۰۰۰ تومان</span></strong> </td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="wc-proceed-to-checkout">
						<a class="checkout-button button alt wc-forward" href="checkout.html">مرحله بعد تایید نهایی</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>

var app = new Vue({

  el: '#app',

  data:{
    shipment_methods: [],
    payment_methods: [],
    payment_method_id: null,
    shipment_method_id: null,
    shipment_price: 0,
    user_orders: [],
    user: "{{current_user.id}}",
    invitation_discount: 0,
    items_discount: 0,
    total_price: 0
  },

  computed: {
    final_price: function(){
      return this.total_price + this.shipment_price + this.invitation_discount + this.items_discount;
    }
  },

  methods:{

    update_payment_id: function(payment_method_id){
      this.payment_method_id = payment_method_id;
    },

    update_shipment_data: function(price, id){
      console.log(price);
      this.shipment_price = price;
      this.shipment_method_id = id;
    },

    handleSubmit: function(){
      var bodyFormData = new FormData();
      bodyFormData.set('final_price', this.final_price);
      bodyFormData.set('payment_method_id', this.payment_method_id);
      bodyFormData.set('shipment_method_id', this.shipment_method_id);
      axios({
        method: 'POST',
        url: '/api/user/checkout/confirm/payment/{{pid}}',
        data: bodyFormData,
        config: { headers: {'Content-Type': 'multipart/form-data' }}
      })
      .then(function (response) {
        //handle success
        window.location = "/confirm/payment/{{pid}}"
        console.log(response);
       })
      .catch(function (response) {
          //handle error
          console.log(response);
      });
    }
  },

  created: function(){
   self = this;0
    $.getJSON("{{url_for('usercheckout')}}", function(data){
      self.shipment_methods = data['shipment_methods'][0];
      self.payment_methods = data['payment_methods'][0];
    });

    if (this.user == ""){
      this.user= true;
    }
    else{
      this.user = false;
    }

    $.getJSON("{{url_for('usercartorder')}}", function(data){
      self.user_orders = data;
    });
  }



});


</script>

ko.applyBindings();
$(document).on('click','.remove',function(e) {
	e.preventDefault();
	item_id = $(this).find('input').val();

	var data = JSON.stringify({
		"item_id": item_id
	});

	var xhr = new XMLHttpRequest();
	xhr.withCredentials = true;

	xhr.open("post", "{{url_for('usercartorderdelete')}}");
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.setRequestHeader("Cache-Control", "no-cache");
	xhr.send(data);
	xhr.onreadystatechange = function (oEvent) {
		if (xhr.readyState === 4) {
				data = JSON.parse(xhr.responseText);
				if (xhr.status === 200) {
					carts = []
					mycart([])
					$.each(data,function(key,val) {
						if(val[0])
							 carts.push(val[0]);
					});
					console.log(carts);
					mycart(carts);
					total_carts(ToPersian(carts.length));
					alert('محصول مورد نظر از سبد خرید حذف شد')
				} else {
					 alert(data.reason)
				}
			}
		};
});
</script>

{% endblock scripts %}
